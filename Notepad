// GUP.exe Spawning Unusual Subprocesses
// Detects cases where the Notepad++ updater (gup.exe) spawns child processes that deviate from the normal and expected.
dataset = xdr_data | fields _time, agent_hostname, event_type, event_sub_type, action_process_username, action_process_user_sid, action_process_image_name, action_process_image_path, action_process_image_command_line, action_process_image_sha256, action_process_os_pid, action_process_cwd, action_process_file_info, action_process_file_size, action_process_file_web_mark, action_process_signature_vendor, action_process_signature_product, action_process_signature_status, actor_effective_username, actor_effective_user_sid, actor_process_image_name, actor_process_image_path, actor_process_command_line, actor_process_signature_vendor, actor_process_signature_product, actor_process_signature_status, causality_actor_primary_username, causality_actor_process_image_name, causality_actor_process_image_path, causality_actor_process_command_line, os_actor_primary_username, os_actor_process_image_name, os_actor_process_image_path, os_actor_process_image_command_line, os_actor_process_image_sha256, action_process_instance_id, actor_process_instance_id, causality_actor_process_instance_id, agent_os_type, agent_id | filter event_type = ENUM.PROCESS      and event_sub_type = ENUM.PROCESS_START  | filter lowercase(actor_process_image_name) = "gup.exe" | filter lowercase(action_process_image_name) !~= "(npp[\.\d]+?installer|consent\.exe|explorer\.exe|werfault\.exe|smartscreen\.exe|adminbyrequest\.exe|openwith\.exe)"     and lowercase(action_process_image_command_line) !~= "(https://urldefense.com/v3/__https://notepad-plus-plus/.org/**A7Chttps:/**Bnpp-user-manual/.org/*__;LyUvLy8v!!B71jDkO1UN9cuT4r0w!9vFo0uSNhlY6BOqNKJ-rIix40WIjv-MjkEek5mW1gFBqlfSuUm43Jj1R9kBbdCLkTUleDssf-KRKh9iPmfFvvKHEeqLH$ )"     and lowercase(actor_process_command_line) !~= "(\\notepad\+\+\\plugins|https://urldefense.com/v3/__https://notepad-plus-plus/.org/*__;Lw!!B71jDkO1UN9cuT4r0w!9vFo0uSNhlY6BOqNKJ-rIix40WIjv-MjkEek5mW1gFBqlfSuUm43Jj1R9kBbdCLkTUleDssf-KRKh9iPmfFvvA6NsSv1$ )" | sort desc _time

// GUP.exe Downloading Improperly Signed Installer
dataset = xdr_data | fields _time, agent_hostname, event_type, event_sub_type, action_process_username, action_process_user_sid, action_process_image_name, action_process_image_path, action_process_image_command_line, action_process_image_sha256, action_process_os_pid, action_process_cwd, action_process_file_info, action_process_file_size, action_process_file_web_mark, action_process_signature_vendor, action_process_signature_product, action_process_signature_status, actor_effective_username, actor_effective_user_sid, actor_process_image_name, actor_process_image_path, actor_process_command_line, actor_process_signature_vendor, actor_process_signature_product, actor_process_signature_status, causality_actor_primary_username, causality_actor_process_image_name, causality_actor_process_image_path, causality_actor_process_command_line, os_actor_primary_username, os_actor_process_image_name, os_actor_process_image_path, os_actor_process_image_command_line, os_actor_process_image_sha256, action_process_instance_id, actor_process_instance_id, causality_actor_process_instance_id, agent_os_type, agent_id | filter event_type = ENUM.PROCESS      and event_sub_type = ENUM.PROCESS_START      and _product = "XDR agent"     and _vendor = "PANW" | filter lowercase(actor_process_image_name) = "gup.exe"     and actor_process_signature_status not in (null, ENUM.UNSUPPORTED, ENUM.FAILED_TO_OBTAIN ) and action_process_signature_status  not in (null, ENUM.UNSUPPORTED, ENUM.FAILED_TO_OBTAIN ) and action_process_image_sha256 not in (     "71431fa7b66f8132453e18e3a5f8ef0af3ca079a7793f828df06fdb5d7bd915d",     "2dd5473736ef51e4340cae005e3fc8cdf0e42ec649bc6ed186484a79be409928",     "a19aa1cd7ecb9ca3f1fd0e118fffd0d673fba404ced8c39c2e210a63b70f9c15",     "e22abc9af328d063e652f0829819124a6a748c224bc8b10f98473f87cda2c0cd",     "61c3077b989e272117167c90fc35e7f06bea4f992f3395b40ccee083d7258082",     "49d2531893b09cb6a8e3429ca0a734e871a2d96fa2575c0eec3229d383fa233a",     "32aa12d3c9521477a5a1e086e400ec0f77f8a97a8190806a0f1953688b883cfb",     "8117c82a3821965d92ee3f9f3ae10efcd602bd4b6e52a2fe957d70aafe479744",     "05abc57952974d08feafa399d6fdb37945a3fd0a10f37833dd837a5788e421d5",     "c6d1e5aacbf69aa18df4caf1346fd69638491a5ad0085729bae91c662d1c62bb",     "e1df78704001bba1a3d343f62a1242a4484ff6ad269170714263c03b802eb0b1",     "7094a07167648628e47249a16d9d6db922e5aa1255ac4322a2e4900d233372dd"     ) | filter lowercase(action_process_image_name) ~= "(npp[\.\d]+?installer)" | dedup agent_id by desc _time | filter action_process_signature_status != ENUM.SIGNED         or lowercase(action_process_signature_vendor) != "notepad++" | sort desc _time

// GUP.exe Writing Unusual Files to Temp Folder
// Detects cases where the Notepad++ updater (gup.exe) writes files to a temp folder that that deviate from the normal and expected.
dataset = xdr_data   | fields _time, agent_hostname, event_type, event_sub_type, action_file_name, action_file_path, actor_effective_username, action_file_extension, action_file_previous_file_path, action_file_sha256, action_file_size, actor_process_image_name, actor_process_image_path, actor_process_command_line, actor_process_image_sha256, causality_actor_process_image_name, causality_actor_process_image_path, os_actor_primary_username, os_actor_process_command_line, os_actor_process_image_name, os_actor_process_image_path, agent_os_type  | filter event_type = ENUM.FILE          and event_sub_type = ENUM.FILE_WRITE  | filter lowercase(actor_process_image_name) = "gup.exe"      and action_file_sha256 != null | filter lowercase(actor_process_command_line) !~= "((\\notepad\+\+(?:_?x?\d+?)??|\\nppp?[\.\d]*?(?:portable)??(?:\.x64)??).*?\\plugins|-ihttps:\/\/notepad-plus-plus\.org\/update\/getdownloadurl\.php)"     and lowercase(action_file_path) ~= "(\\appdata\\local\\temp\\|\\windows\\temp)"      and lowercase(action_file_name) !~= "(npp[\.\d]+?installer)" | sort desc _time

// Chrysalis Mutex
// Identifies a Mutex known to be related to the chrysalis backdoor malware
config case_sensitive = false  | dataset = xdr_data  | fields _time, agent_hostname, actor_effective_username, actor_process_image_name, actor_process_image_path, actor_process_command_line, event_type, event_sub_type, action_syscall_string_params | filter event_type = ENUM.SYSTEM_CALL and event_sub_type = ENUM.SYSTEM_CALL_NT_CREATE_MUTANT  | alter mutex = json_extract_scalar(action_syscall_string_params, "$.1")  | filter mutex = "Global\\Jdhfv_1.0.1"

// DLL sideloading via BYO application
// Identifies masquerading bitdefender processes loading a log.dll file
config case_sensitive = false | dataset = xdr_data | fields actor_process_signature_vendor, actor_process_signature_product, action_module_path, actor_process_image_path, actor_process_image_sha256, agent_os_type, event_type, event_id, agent_hostname, _time, actor_process_image_name  | filter event_type = ENUM.LOAD_IMAGE and agent_os_type = ENUM.AGENT_OS_WINDOWS | filter actor_process_signature_vendor contains "Bitdefender SRL" and action_module_path contains "log.dll" | alter actor_process_image_name = lowercase(actor_process_image_name) | filter actor_process_image_path not contains "Program Files\Bitdefender"  | filter not actor_process_image_name in ("eps.rmm64.exe", "downloader.exe", "installer.exe", "epconsole.exe", "EPHost.exe", "epintegrationservice.exe", "EPPowerConsole.exe", "epprotectedservice.exe", "DiscoverySrv.exe", "epsecurityservice.exe", "EPSecurityService.exe", "epupdateservice.exe", "testinitsigs.exe", "EPHost.Integrity.exe", "WatchDog.exe", "ProductAgentService.exe", "EPLowPrivilegeWorker.exe", "Product.Configuration.Tool.exe", "eps.rmm.exe")


//Notepad++ GUP.exe Update Process Hijacking Detection
//Detects gup.exe spawning suspicious child processes indicating update hijacking

config case_sensitive = false timeframe = 30d
| dataset = xdr_data
| filter event_type = ENUM.PROCESS and event_sub_type = ENUM.PROCESS_START
| filter actor_process_image_name = "gup.exe"
| filter action_process_image_name != "explorer.exe"
| filter action_process_image_name !~= "^npp\..*\.Installer.*\.exe$"
| filter action_process_image_name in (
    "update.exe", "AutoUpdater.exe", "curl.exe", "cmd.exe", 
    "powershell.exe", "wscript.exe", "cscript.exe", "rundll32.exe"
) or action_process_image_path contains "\\Temp\\" or
     action_process_image_path contains "\\tmp\\" or
     action_process_image_path contains "AppData\\Local\\"
| fields _time, agent_hostname, actor_process_image_name, actor_process_command_line, action_process_image_name, action_process_image_path, action_process_image_command_line, actor_effective_username, causality_actor_process_image_name, causality_actor_process_command_line


// Known Notepad++ malicious C2 / URL hosts
let MaliciousHosts = dynamic([
  "45.76.155.202", "45.32.144.255",
  "95.179.213.0", "temp.sh",
  "cdncheck.it.com", "safe-dns.it.com",
  "self-dns.it.com", "45.77.31.210"
]);
// Search DNS resolutions to these hosts
DeviceNetworkEvents
| where RemoteUrl has_any (MaliciousHosts)
| project Timestamp, DeviceName, InitiatingProcessFileName, RemoteUrl, RemoteIP, RemotePort, ActionType

| union
// Look for HTTP requests to known malicious domains or URL paths
DeviceNetworkEvents
| where (RemoteUrl contains "update/update.exe"
       or RemoteUrl contains "/users/admin"
       or RemoteUrl contains "/api/")
| where RemoteIP in (MaliciousHosts)
| project Timestamp, DeviceName, InitiatingProcessFileName, RemoteUrl, RemoteIP, RemotePort;


// Notepad++ Supply Chain Attack Detection
let Lookback = 90d;
// Updater Execution
let SuspiciousUpdaterExecution = 
    DeviceProcessEvents
    | where Timestamp > ago(Lookback)
    | where InitiatingProcessFileName in~ ("update.exe", "gup.exe")
    | where FileName in~ (
        "cmd.exe",
        "powershell.exe", 
        "pwsh.exe",
        "rundll32.exe",
        "mshta.exe", 
        "curl.exe",
        "wget.exe",
        "certutil.exe"
    )
    | where ProcessCommandLine has_any (
        "whoami", "tasklist", "systeminfo", "netstat", "ipconfig",
        "http", "curl", "wget", "certutil", "bitsadmin", 
        "download", "upload",
        "Invoke-Expression", "IEX", "iex", "FromBase64String", "Base64"
    )
    and ProcessCommandLine has_any (">", ">>", ".txt", ".log", "-s", "-F")
    | project
        DeviceId,
        DeviceName,
        UpdateTime = Timestamp,
        UpdaterFile = FileName,
        UpdaterPath = FolderPath,
        UpdaterCommand = ProcessCommandLine,
        UpdaterPID = ProcessId,
        AccountName;
// Post-Update activity
let PostUpdateActivity = 
    DeviceProcessEvents
    | where Timestamp > ago(Lookback)
    | where InitiatingProcessFileName in~ ("update.exe", "gup.exe")
    | where FileName in~ (
        "cmd.exe",
        "powershell.exe",
        "pwsh.exe", 
        "rundll32.exe",
        "mshta.exe",
        "curl.exe"
    )
    | where ProcessCommandLine has_any (
        "whoami",
        "tasklist", 
        "systeminfo",
        "netstat",
        "ipconfig",
        "http",
        "curl"
    )
    and ProcessCommandLine has_any ("-F", "-s", ">", ">>", ".txt")
    | project
        DeviceId,
        ActivityTime = Timestamp,
        ProcessName = FileName,
        CommandLine = ProcessCommandLine,
        ProcessPath = FolderPath,
        ParentProcess = InitiatingProcessFileName,
        ProcessPID = ProcessId;
// Dll Sideloading
let SuspiciousDLLLoads = 
    DeviceImageLoadEvents
    | where Timestamp > ago(Lookback) 
    | where FolderPath has_any ("\\AppData\\", "\\Temp\\")
    // Optional: Known malicious DLLs or suspicious loaders
    | where FileName in~ (
        "log.dll", 
        "alien.dll", 
        "lua5.1.dll", 
        "alien.ini"
    ) 
    or InitiatingProcessFileName in~ (
        "BluetoothService.exe", 
        "script.exe"
    )
    | project
        DeviceId,
        LoadTime = Timestamp,
        LoadedModule = FileName,
        ModulePath = FolderPath,
        LoadingProcess = InitiatingProcessFileName;
// Network Activity
let SuspiciousNetworkConnections = 
    DeviceNetworkEvents
    | where Timestamp > ago(Lookback)
    | where InitiatingProcessFileName in~ (
        "cmd.exe",
        "powershell.exe",
        "pwsh.exe",
        "curl.exe", 
        "rundll32.exe",
        "mshta.exe"
    )
    | project
        DeviceId,
        ConnectionTime = Timestamp,
        NetworkProcess = InitiatingProcessFileName,
        RemoteUrl,
        RemoteIP,
        RemotePort;
// Correlation
SuspiciousUpdaterExecution
| join kind=inner PostUpdateActivity on DeviceId
    | where ActivityTime between (UpdateTime .. (UpdateTime + time(10m)))
| join kind=leftouter SuspiciousDLLLoads on DeviceId
    | where isnull(LoadTime) or LoadTime between (UpdateTime .. (UpdateTime + time(10m)))
| join kind=leftouter SuspiciousNetworkConnections on DeviceId
    | where isnull(ConnectionTime) or ConnectionTime between (UpdateTime .. (UpdateTime + time(10m)))
| project
    Timestamp = UpdateTime,
    DeviceName,
    AccountName,
    UpdaterProcess = UpdaterFile,
    UpdaterPath, 
    UpdaterCommand,
    ChildProcess = ProcessName,
    ChildCommand = CommandLine,
    LoadedModule,
    ModulePath,
    RemoteUrl,
    RemoteIP,
    RemotePort
| order by Timestamp desc



//IOCs provided by Rapid7, this is a high FP query and you will need to add exceptions in order to clean it up. Ideally, you have an inventory of devices that have had Notepad++ installed and you can uncomment and explicity define the devices on line 12-15 and comment out lines 10-11. 10-11 is a pretty wide approach.
let notepadDevices = DeviceFileEvents
| where 
    TimeGenerated > ago(400d)
| where 
    FileName == "notepad++.exe"
| summarize by DeviceName
;
union DeviceFileEvents, DeviceProcessEvents, DeviceNetworkEvents
| where 
    TimeGenerated between (datetime(2025-06-01) .. datetime(2025-12-03))
| where 
    DeviceName has_any (notepadDevices)
// | where 
//     DeviceName has_any(
//         "exampleDevice"
//     )
| extend 
    iocFlag = case(FileName has_any (
        "update.exe",
        "[NSIS.nsi]",
        "BluetoothService.exe",
        "BluetoothService",
        "log.dll",
        "u.bat",
        "conf.c",
        "libtcc.dll",
        //admin is going to cause a lot of FP, SHA256 still added below
        //"admin",
        "loader1",
        "uffhxpSy",
        "loader2",
        "3yzr31vk",
        "ConsoleApplication2.exe",
        //system is going to cause a lot of FP, SHA256 still added below
        //"system",
        "s047t5g.exe"
        ), strcat("FileName: ", FileName),
        ProcessCommandLine has_any (
        "update.exe",
        "[NSIS.nsi]",
        "BluetoothService.exe",
        "BluetoothService",
        "log.dll",
        "u.bat",
        "conf.c",
        "libtcc.dll",
        //admin is going to cause a lot of FP, SHA256 still added below
        //"admin",
        "loader1",
        "uffhxpSy",
        "loader2",
        "3yzr31vk",
        "ConsoleApplication2.exe",
        //system is going to cause a lot of FP, SHA256 still added below        
        //"system",
        "s047t5g.exe"
        ), strcat("ProcessCommandLine: ", ProcessCommandLine),
        InitiatingProcessCommandLine has_any (
        "update.exe",
        "[NSIS.nsi]",
        "BluetoothService.exe",
        "BluetoothService",
        "log.dll",
        "u.bat",
        "conf.c",
        "libtcc.dll",
        //admin is going to cause a lot of FP, SHA256 still added below
        //"admin",
        "loader1",
        "uffhxpSy",
        "loader2",
        "3yzr31vk",
        "ConsoleApplication2.exe",
        //system is going to cause a lot of FP, SHA256 still added below
        //"system",
        "s047t5g.exe"
        ), strcat("InitiatingProcessCommandLine: ", InitiatingProcessCommandLine),
         SHA256 has_any (
        "a511be5164dc1122fb5a7daa3eef9467e43d8458425b15a640235796006590c9",
        "8ea8b83645fba6e23d48075a0d3fc73ad2ba515b4536710cda4f1f232718f53e",
        "2da00de67720f5f13b17e9d985fe70f10f153da60c9ab1086fe58f069a156924",
        "77bfea78def679aa1117f569a35e8fd1542df21f7e00e27f192c907e61d63a2e",
        "3bdc4c0637591533f1d4198a72a33426c01f69bd2e15ceee547866f65e26b7ad",
        "9276594e73cda1c69b7d265b3f08dc8fa84bf2d6599086b9acc0bb3745146600",
        "f4d829739f2d6ba7e3ede83dad428a0ced1a703ec582fc73a4eee3df3704629a",
        "4a52570eeaf9d27722377865df312e295a7a23c3b6eb991944c2ecd707cc9906",
        "831e1ea13a1bd405f5bda2b9d8f2265f7b1db6c668dd2165ccc8a9c4c15ea7dd",
        "0a9b8df968df41920b6ff07785cbfebe8bda29e6b512c94a3b2a83d10014d2fd",
        "4c2ea8193f4a5db63b897a2d3ce127cc5d89687f380b97a1d91e0c8db542e4f8",
        "e7cd605568c38bd6e0aba31045e1633205d0598c607a855e2e1bca4cca1c6eda",
        "078a9e5c6c787e5532a7e728720cbafee9021bfec4a30e3c2be110748d7c43c5",
        "b4169a831292e245ebdffedd5820584d73b129411546e7d3eccf4663d5fc5be3",
        "7add554a98d3a99b319f2127688356c1283ed073a084805f14e33b4f6a6126fd",
        "fcc2765305bcd213b7558025b2039df2265c3e0b6401e4833123c461df2de51a"
        ), strcat("SHA256: ", SHA256),
        RemoteIP has_any (
        "95.179.213.0",
        "61.4.102.97",
        "59.110.7.32",
        "124.222.137.114"
        ), strcat("RemoteIP: ", RemoteIP),
        RemoteUrl has_any (
        "api.skycloudcenter.com",
        "api.wiresguard.com",
        "95.179.213.0",
        "61.4.102.97",
        "59.110.7.32",
        "124.222.137.114"
        ), strcat("RemoteUrl: ", RemoteUrl),
        ""
        )
| where iocFlag != ""
//| project TimeGenerated, iocFlag, DeviceName
